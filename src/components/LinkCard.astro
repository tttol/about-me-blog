---
interface Props {
    url: string;
}

const { url } = Astro.props;

let title = url;
let description = '';
let image = '';
let siteName = new URL(url).hostname;

try {
    const response = await fetch(url);
    const html = await response.text();

    const titleMatch = html.match(/<meta\s+property="og:title"\s+content="([^"]+)"/i)
        || html.match(/<meta\s+content="([^"]+)"\s+property="og:title"/i)
        || html.match(/<title>([^<]+)<\/title>/i);
    if (titleMatch) title = titleMatch[1];

    const descMatch = html.match(/<meta\s+property="og:description"\s+content="([^"]+)"/i)
        || html.match(/<meta\s+content="([^"]+)"\s+property="og:description"/i)
        || html.match(/<meta\s+name="description"\s+content="([^"]+)"/i);
    if (descMatch) description = descMatch[1];

    const imageMatch = html.match(/<meta\s+property="og:image"\s+content="([^"]+)"/i)
        || html.match(/<meta\s+content="([^"]+)"\s+property="og:image"/i);
    if (imageMatch) image = imageMatch[1];

    const siteMatch = html.match(/<meta\s+property="og:site_name"\s+content="([^"]+)"/i)
        || html.match(/<meta\s+content="([^"]+)"\s+property="og:site_name"/i);
    if (siteMatch) siteName = siteMatch[1];
} catch (e) {
    console.error(`Failed to fetch OGP for ${url}:`, e);
}
---

<a href={url} class="link-card" target="_blank" rel="noopener noreferrer">
    {image && <img src={image} alt="" class="link-card-image" />}
    <div class="link-card-content">
        <div class="link-card-title">{title}</div>
        {description && <div class="link-card-description">{description}</div>}
        <div class="link-card-site">{siteName}</div>
    </div>
</a>

<style>
    .link-card {
        display: flex;
        align-items: center;
        border: 1px solid rgba(var(--gray), 0.5);
        border-radius: 8px;
        overflow: hidden;
        text-decoration: none;
        background: rgba(var(--gray-light), 0.3);
        margin: 1em 0;
        transition: box-shadow 0.2s ease;
    }
    .link-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .link-card-image {
        width: 120px;
        height: 120px;
        object-fit: cover;
        flex-shrink: 0;
        margin-left: 1em;
    }
    .link-card-content {
        padding: 0.75em 1em;
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
    }
    .link-card-title {
        color: rgb(var(--black));
        font-weight: bold;
        font-size: 1em;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    .link-card-description {
        color: rgb(var(--gray));
        font-size: 0.85em;
        margin-top: 0.3em;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    .link-card-site {
        color: rgb(var(--gray));
        font-size: 0.75em;
        margin-top: 0.5em;
    }
    @media (max-width: 480px) {
        .link-card {
            flex-direction: column;
        }
        .link-card-image {
            width: 100%;
            height: 160px;
        }
    }
</style>
